From ae4d59aab65f4070422909b63ada813e8d9ac273 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Marczykowski-G=C3=B3recki?=
 <marmarek@invisiblethingslab.com>
Date: Sun, 14 Sep 2025 04:08:44 +0200
Subject: [PATCH] Prepare salt.utils.process for python 3.14

Python 3.14 changed multiprocessing method from 'fork' to 'forkserver'
on Linux too:
https://github.com/python/cpython/issues/84559

This leads to issue similar to when Python 3.8 changed it on Mac OS:
https://github.com/saltstack/salt/issues/57742

Change the condition to check for != 'fork' instead of == 'spawn'.
---
 changelog/68148.changed.md | 1 +
 salt/utils/process.py      | 2 +-
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/changelog/68148.changed.md b/changelog/68148.changed.md
index 7964ffa5e02..3f6a8d7a0cb 100644
--- a/changelog/68148.changed.md
+++ b/changelog/68148.changed.md
@@ -1 +1,2 @@
 Update packaged python from 3.10 to 3.11
+Fix salt.utils.process for python 3.14
diff --git a/salt/utils/process.py b/salt/utils/process.py
index eeac663c03a..fcc93147dbd 100644
--- a/salt/utils/process.py
+++ b/salt/utils/process.py
@@ -897,7 +897,7 @@ class Process(multiprocessing.Process):
         instance._finalize_methods = []
         instance.__logging_config__ = salt._logging.get_logging_options_dict()
 
-        if salt.utils.platform.spawning_platform():
+        if multiprocessing.get_start_method() != "fork":
             # On spawning platforms, subclasses should call super if they define
             # __setstate__ and/or __getstate__
             instance._args_for_getstate = copy.copy(args)
-- 
2.51.0

